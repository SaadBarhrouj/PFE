name: CI - Pull Request Validation

on:
  pull_request:
    branches:
      - uat
      - main
    paths:
      - 'force-app/**'

jobs:
  # ================================================================
  # JOB 1: Static Code Analysis (PMD)
  # ================================================================
  static-analysis:
    name: Static Code Analysis (PMD)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run PMD Static Analysis
        id: pmd
        uses: pmd/pmd-github-action@v2
        with:
          sourcePath: 'force-app'
          rulesets: 'config/ruleset.xml'
          analyzeModifiedFilesOnly: true
          createGitHubAnnotations: true

      - name: Upload PMD SARIF report
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pmd-report.sarif

      - name: Fail if violations found
        if: steps.pmd.outputs.violations != 0
        run: |
          echo "PMD found ${{ steps.pmd.outputs.violations }} violation(s)."
          echo "Please fix the code quality issues before merging."
          exit 1

  # ================================================================
  # JOB 2: Scratch Org Tests (PRs → uat only)
  # ================================================================
  scratch-org-test:
    name: Build & Test (Scratch Org)
    needs: static-analysis
    if: github.base_ref == 'uat'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Salesforce CLI
        id: cache-sf-cli
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/sf
            ~/.cache/sf
            /usr/local/lib/node_modules/@salesforce
          key: sf-cli-${{ runner.os }}-v2
          restore-keys: |
            sf-cli-${{ runner.os }}-

      - name: Install Salesforce CLI
        if: steps.cache-sf-cli.outputs.cache-hit != 'true'
        run: |
          npm install --global @salesforce/cli
          sf --version

      - name: Verify Salesforce CLI
        if: steps.cache-sf-cli.outputs.cache-hit == 'true'
        run: sf --version

      - name: Authenticate Dev Hub
        run: |
          echo "${{ secrets.DEVHUB_AUTH_URL }}" > auth.url
          sf org login sfdx-url \
            --sfdx-url-file auth.url \
            --set-default-dev-hub \
            --alias DevHub
          rm -f auth.url

      - name: Create Scratch Org
        run: |
          sf org create scratch \
            --definition-file config/project-scratch-def.json \
            --alias scratch-ci \
            --set-default \
            --duration-days 1

      - name: Push Source to Scratch Org
        run: sf project deploy start --target-org scratch-ci

      - name: Run Apex Tests
        run: |
          sf apex run test \
            --target-org scratch-ci \
            --wait 15 \
            --result-format human \
            --code-coverage

      - name: Delete Scratch Org
        if: always()
        run: sf org delete scratch --target-org scratch-ci --no-prompt

  # ================================================================
  # JOB 3: Production Validation (validate → generates Job ID)
  # ================================================================
  validate-production:
    name: Validate Against Production
    needs: static-analysis
    if: github.base_ref == 'main'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Salesforce CLI
        id: cache-sf-cli
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/sf
            ~/.cache/sf
            /usr/local/lib/node_modules/@salesforce
          key: sf-cli-${{ runner.os }}-v2
          restore-keys: |
            sf-cli-${{ runner.os }}-

      - name: Install Salesforce CLI
        if: steps.cache-sf-cli.outputs.cache-hit != 'true'
        run: |
          npm install --global @salesforce/cli
          sf --version

      - name: Verify Salesforce CLI
        if: steps.cache-sf-cli.outputs.cache-hit == 'true'
        run: sf --version

      - name: Authenticate Production Org
        run: |
          echo "${{ secrets.PRODUCTION_AUTH_URL }}" > auth.url
          sf org login sfdx-url \
            --sfdx-url-file auth.url \
            --alias ProductionOrg \
            --set-default
          rm -f auth.url

      - name: Validate Deployment (Generates Job ID)
        id: validate
        run: |
          echo "Running full validation against Production..."
          
          set +e
          RESULT=$(sf project deploy validate \
            --source-dir force-app \
            --target-org ProductionOrg \
            --test-level RunLocalTests \
            --wait 30 \
            --json 2>&1)
          EXIT_CODE=$?
          set -e
          
          echo "$RESULT"
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo ""
            echo "============================================"
            echo "VALIDATION FAILED"
            echo "============================================"
            
            ERROR_MSG=$(echo "$RESULT" | jq -r '.message // .result.errorMessage // "Unknown error"' 2>/dev/null || echo "Could not parse error")
            echo "Error: $ERROR_MSG"
            
            FAILED_TESTS=$(echo "$RESULT" | jq -r '.result.details.runTestResult.failures[]?.name // empty' 2>/dev/null || true)
            if [ -n "$FAILED_TESTS" ]; then
              echo ""
              echo "Failed tests:"
              echo "$FAILED_TESTS"
            fi
            
            DEPLOY_ERRORS=$(echo "$RESULT" | jq -r '.result.details.componentFailures[]?.problem // empty' 2>/dev/null || true)
            if [ -n "$DEPLOY_ERRORS" ]; then
              echo ""
              echo "Component errors:"
              echo "$DEPLOY_ERRORS"
            fi
            
            JOB_ID=$(echo "$RESULT" | jq -r '.result.id // empty' 2>/dev/null || true)
            if [ -n "$JOB_ID" ]; then
              echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
            fi
            
            echo "============================================"
            exit 1
          fi
          
          JOB_ID=$(echo "$RESULT" | jq -r '.result.id')
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
          echo "Validation Successful - Job ID: $JOB_ID"

      - name: Post Job ID to PR
        if: success()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: deploy-job-id
          message: |
            ## Production Validation Successful

            | Info | Value |
            |------|-------|
            | **Job ID** | `${{ steps.validate.outputs.job_id }}` |
            | **Status** | Validated — Ready for Quick Deploy |

            ### Deployment Options:
            
            **Option A — Salesforce Setup:**
            1. Navigate to Setup → Environments → Deploy → Deployment Status
            2. Click **Quick Deploy**
            
            **Option B — GitHub Actions:**
            1. Go to Actions tab → **CD - Deploy to Production**
            2. Click **Run workflow**
            3. Enter the Job ID: `${{ steps.validate.outputs.job_id }}`

            > Note: The Job ID expires after **10 days**.

      # ── Slack — Validation Prod Success ──
      - name: Slack — Production Validated
        if: success()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_DEPLOYMENTS }}
          payload: |
            {
              "text": "Production validation successful — PR #${{ github.event.pull_request.number }}",
              "attachments": [
                {
                  "color": "#28a745",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "Production Validation Successful",
                        "emoji": false
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Job ID:*\n`${{ steps.validate.outputs.job_id }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*PR:*\n<${{ github.event.pull_request.html_url }}|#${{ github.event.pull_request.number }} — ${{ github.event.pull_request.title }}>"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Author:*\n`${{ github.actor }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Branch:*\n`${{ github.head_ref }}` → `main`"
                        }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "The validation for production has completed successfully. It is now ready for quick deployment."
                      }
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "View Pull Request"
                          },
                          "url": "${{ github.event.pull_request.html_url }}"
                        },
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "View Workflow"
                          },
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      # ── Slack — Validation Prod FAILED ──
      - name: Slack — Production Validation Failed
        if: failure()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_DEPLOYMENTS }}
          payload: |
            {
              "text": "Production validation failed — PR #${{ github.event.pull_request.number }}",
              "attachments": [
                {
                  "color": "#dc3545",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "Production Validation Failed",
                        "emoji": false
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*PR:*\n<${{ github.event.pull_request.html_url }}|#${{ github.event.pull_request.number }} — ${{ github.event.pull_request.title }}>"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Author:*\n`${{ github.actor }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Branch:*\n`${{ github.head_ref }}` → `main`"
                        }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "The validation for production has failed. Please review the errors in the pull request or workflow logs."
                      }
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "View Logs"
                          },
                          "style": "danger",
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

  # ================================================================
  # JOB 4: PR Comment
  # ================================================================
  pr-comment:
    name: Pull Request Results Comment
    needs: [static-analysis, scratch-org-test, validate-production]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      pull-requests: write
    steps:
      - name: Determine overall status
        id: status
        run: |
          ANALYSIS="${{ needs.static-analysis.result }}"
          if [ "$ANALYSIS" = "success" ]; then
            echo "analysis_icon=PASSED" >> $GITHUB_OUTPUT
            echo "analysis_text=No violations found" >> $GITHUB_OUTPUT
          elif [ "$ANALYSIS" = "skipped" ]; then
            echo "analysis_icon=SKIPPED" >> $GITHUB_OUTPUT
            echo "analysis_text=Skipped" >> $GITHUB_OUTPUT
          else
            echo "analysis_icon=FAILED" >> $GITHUB_OUTPUT
            echo "analysis_text=Code quality issues detected" >> $GITHUB_OUTPUT
          fi

          TARGET="${{ github.base_ref }}"

          if [ "$TARGET" = "uat" ]; then
            VALIDATION="${{ needs.scratch-org-test.result }}"
            echo "validation_label=Apex Tests (Scratch Org)" >> $GITHUB_OUTPUT
            echo "target_env=UAT" >> $GITHUB_OUTPUT
          else
            VALIDATION="${{ needs.validate-production.result }}"
            echo "validation_label=Production Validation" >> $GITHUB_OUTPUT
            echo "target_env=Production" >> $GITHUB_OUTPUT
          fi

          if [ "$VALIDATION" = "success" ]; then
            echo "validation_icon=PASSED" >> $GITHUB_OUTPUT
            echo "validation_text=Passed" >> $GITHUB_OUTPUT
          elif [ "$VALIDATION" = "skipped" ]; then
            echo "validation_icon=SKIPPED" >> $GITHUB_OUTPUT
            echo "validation_text=Skipped (prerequisite failed)" >> $GITHUB_OUTPUT
          else
            echo "validation_icon=FAILED" >> $GITHUB_OUTPUT
            echo "validation_text=Failed — See Workflow log for details" >> $GITHUB_OUTPUT
          fi

          if [ "$ANALYSIS" = "success" ] && [ "$VALIDATION" = "success" ]; then
            echo "overall=All checks passed — Ready to merge into $TARGET" >> $GITHUB_OUTPUT
          else
            echo "overall=Some checks failed — Please resolve issues before merging" >> $GITHUB_OUTPUT
          fi

      - name: Post PR Comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: ci-results
          message: |
            ## CI Pipeline Results — Target: `${{ github.base_ref }}`

            | Check | Status | Details |
            |-------|--------|---------|
            | **Static Analysis (PMD)** | ${{ steps.status.outputs.analysis_icon }} | ${{ steps.status.outputs.analysis_text }} |
            | **${{ steps.status.outputs.validation_label }}** | ${{ steps.status.outputs.validation_icon }} | ${{ steps.status.outputs.validation_text }} |

            ### ${{ steps.status.outputs.overall }}

            ---
            *Target environment: **${{ steps.status.outputs.target_env }}***
            <sub>Automated by CI Pipeline — <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Full Run</a></sub>

  # ================================================================
  # Slack — CI Failure
  # ================================================================
  slack-notify-ci:
    name: Slack — CI Failure
    needs: [static-analysis, scratch-org-test, validate-production]
    if: |
      always() && (
        needs.static-analysis.result == 'failure' ||
        needs.scratch-org-test.result == 'failure' ||
        needs.validate-production.result == 'failure'
      )
    runs-on: ubuntu-latest
    steps:
      - name: Resolve Slack mention for PR author
        id: author
        run: |
          MAP='${{ secrets.SLACK_GITHUB_USERS_MAP }}'
          AUTHOR="${{ github.event.pull_request.user.login }}"
          SLACK_ID=""
          if [ -n "$MAP" ] && [ "$MAP" != "" ]; then
            SLACK_ID=$(echo "$MAP" | jq -r --arg user "$AUTHOR" '.[$user] // empty' 2>/dev/null || true)
          fi
          if [ -n "$SLACK_ID" ]; then
            echo "mention=<@$SLACK_ID>" >> $GITHUB_OUTPUT
          else
            echo "mention=\`$AUTHOR\`" >> $GITHUB_OUTPUT
          fi

      - name: Build failure details
        id: details
        run: |
          ANALYSIS="${{ needs.static-analysis.result }}"
          SCRATCH="${{ needs.scratch-org-test.result }}"
          PROD_VAL="${{ needs.validate-production.result }}"
          TARGET="${{ github.base_ref }}"
          FAILURES=""

          if [ "$ANALYSIS" = "failure" ]; then
            FAILURES="${FAILURES}• Static Analysis (PMD)\n"
          fi
          if [ "$TARGET" = "uat" ] && [ "$SCRATCH" = "failure" ]; then
            FAILURES="${FAILURES}• Scratch Org Tests\n"
          fi
          if [ "$TARGET" = "main" ] && [ "$PROD_VAL" = "failure" ]; then
            FAILURES="${FAILURES}• Production Validation\n"
          fi

          echo "failures=$FAILURES" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_CI }}
          payload: |
            {
              "text": "CI pipeline failed — PR #${{ github.event.pull_request.number }} by ${{ github.event.pull_request.user.login }}",
              "attachments": [
                {
                  "color": "#dc3545",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "CI Pipeline Failed",
                        "emoji": false
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*PR:*\n<${{ github.event.pull_request.html_url }}|#${{ github.event.pull_request.number }} — ${{ github.event.pull_request.title }}>"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Author:*\n${{ steps.author.outputs.mention }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Target Branch:*\n`${{ github.base_ref }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Source Branch:*\n`${{ github.head_ref }}`"
                        }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "*Failed Checks:*\n${{ steps.details.outputs.failures }}"
                      }
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "View Logs"
                          },
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        },
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "View PR"
                          },
                          "url": "${{ github.event.pull_request.html_url }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
