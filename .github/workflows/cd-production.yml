name: CD - Deploy to Production

on:
  push:
    branches:
      - main
    paths:
      - 'force-app/**'

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy-to-production:
    name: üöÄ Deploy to Production Org
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Salesforce CLI
        id: cache-sf-cli
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/sf
            ~/.cache/sf
            /usr/local/lib/node_modules/@salesforce
          key: sf-cli-${{ runner.os }}-v2
          restore-keys: |
            sf-cli-${{ runner.os }}-

      - name: Install Salesforce CLI
        if: steps.cache-sf-cli.outputs.cache-hit != 'true'
        run: |
          npm install --global @salesforce/cli
          sf --version

      - name: Verify Salesforce CLI
        if: steps.cache-sf-cli.outputs.cache-hit == 'true'
        run: sf --version

      - name: Authenticate Production Org
        run: |
          echo "${{ secrets.PRODUCTION_AUTH_URL }}" > auth.url
          sf org login sfdx-url \
            --sfdx-url-file auth.url \
            --alias ProductionOrg \
            --set-default
          rm -f auth.url

      - name: Deploy to Production Org
        run: |
          echo "üöÄ Deploying to Production Org..."
          sf project deploy start \
            --source-dir force-app \
            --target-org ProductionOrg \
            --test-level RunLocalTests \
            --wait 30

      - name: Deployment Summary
        if: success()
        run: |
          echo "============================================"
          echo "‚úÖ DEPLOYMENT TO PRODUCTION SUCCESSFUL"
          echo "============================================"
          echo "Branch:      main"
          echo "Commit:      ${{ github.sha }}"
          echo "Author:      ${{ github.actor }}"
          echo "Timestamp:   $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "============================================"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "============================================"
          echo "‚ùå DEPLOYMENT TO PRODUCTION FAILED"
          echo "============================================"
          echo "Check the logs above for details."
          echo "============================================"

      # ‚îÄ‚îÄ Slack ‚Äî Production Success ‚Üí @channel ‚îÄ‚îÄ
      - name: üîî Slack ‚Äî Production Deployed Successfully
        if: success()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_DEPLOYMENTS }}
          payload: |
            {
              "text": "‚úÖ Production d√©ploy√©e avec succ√®s ‚Äî <!channel>",
              "attachments": [
                {
                  "color": "#28a745",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "üöÄ D√©ploiement Production r√©ussi",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Environnement:*\nüè≠ Production"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Auteur:*\n`${{ github.actor }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Commit:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|`${{ github.sha }}`>"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Branche:*\n`main`"
                        }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "<!channel> ‚úÖ Une nouvelle version a √©t√© d√©ploy√©e en production.\n\n*Message:* ${{ github.event.head_commit.message }}"
                      }
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "üìã Voir le run"
                          },
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      # ‚îÄ‚îÄ  Slack ‚Äî Production Failure ‚Üí @here ALERTE ‚îÄ‚îÄ
      - name: üîî Slack ‚Äî ALERTE Production Failed
        if: failure()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_DEPLOYMENTS }}
          payload: |
            {
              "text": "üö® ALERTE ‚Äî √âchec du d√©ploiement Production ‚Äî <!here>",
              "attachments": [
                {
                  "color": "#dc3545",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "üö® ALERTE ‚Äî D√©ploiement Production √âCHOU√â",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Environnement:*\nüè≠ Production"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Auteur:*\n`${{ github.actor }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Commit:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|`${{ github.sha }}`>"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Branche:*\n`main`"
                        }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "<!here> üî¥ *Le d√©ploiement en production a √©chou√© !*\nIntervention imm√©diate requise.\n\n*Message du commit:* ${{ github.event.head_commit.message }}"
                      }
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "üî¥ VOIR LES LOGS IMM√âDIATEMENT"
                          },
                          "style": "danger",
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}